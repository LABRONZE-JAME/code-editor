<!DOCTYPE html>
<html lang="en">
<head>
    <title>Code Editor</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap');

        :root {
            /* Base Colors */
            --background-color: #121212; /* Very dark gray (almost black) for the page background */
            --navbar-background: #1E1E1E; /* Dark gray for navbar background */
            --navbar-text-color: #E0E0E0; /* Light gray text color for readability */
            --card-background-color: #1C1C1C; /* Slightly lighter dark gray for cards */
            --input-background-color: #333333; /* Dark gray for input fields */
            --input-text-color: #FFFFFF; /* White text color for input fields */
            
            /* Button Colors */
            --button-color: #444444; /* Medium gray for button background */
            --button-hover-color: #666666; /* Lighter gray for button hover */
            --button-active-color: #888888; /* Even lighter gray for button active state */
            --button-text-color: #E0E0E0; /* Light gray text for buttons */
            
            /* Text and Border Colors */
            --navbar-border-color: #333333; /* Dark border color for navbar */
            --error-color: #FF5252; /* Red for error messages */
            --success-color: #4CAF50; /* Green for success messages */
            --warning-color: #FF9800; /* Orange for warning messages */
            
            /* Light Gray Tones */
            --light-gray: #BDBDBD; /* Light gray for general text */
            --white: #FFFFFF; /* Pure white for contrast */
            --dark-gray: #212121; /* Darker gray for cards, sections, etc. */
        }

        .roboto-thin { font-family: "Roboto", sans-serif; font-weight: 100; font-style: normal; }
        .roboto-light { font-family: "Roboto", sans-serif; font-weight: 300; font-style: normal; }
        .roboto-regular { font-family: "Roboto", sans-serif; font-weight: 400; font-style: normal; }
        .roboto-medium { font-family: "Roboto", sans-serif; font-weight: 500; font-style: normal; }
        .roboto-bold { font-family: "Roboto", sans-serif; font-weight: 700; font-style: normal; }
        .roboto-black { font-family: "Roboto", sans-serif; font-weight: 900; font-style: normal; }
        .roboto-thin-italic { font-family: "Roboto", sans-serif; font-weight: 100; font-style: italic; }
        .roboto-light-italic { font-family: "Roboto", sans-serif; font-weight: 300; font-style: italic; }
        .roboto-regular-italic { font-family: "Roboto", sans-serif; font-weight: 400; font-style: italic; }
        .roboto-medium-italic { font-family: "Roboto", sans-serif; font-weight: 500; font-style: italic; }
        .roboto-bold-italic { font-family: "Roboto", sans-serif; font-weight: 700; font-style: italic; }
        .roboto-black-italic { font-family: "Roboto", sans-serif; font-weight: 900; font-style: italic; }

        .fira-code-thin { font-family: "Fira Code", monospace; font-weight: 100; font-style: normal; }
        .fira-code-light { font-family: "Fira Code", monospace; font-weight: 300; font-style: normal; }
        .fira-code-regular { font-family: "Fira Code", monospace; font-weight: 400; font-style: normal; }
        .fira-code-medium { font-family: "Fira Code", monospace; font-weight: 500; font-style: normal; }
        .fira-code-bold { font-family: "Fira Code", monospace; font-weight: 700; font-style: normal; }
        .fira-code-black { font-family: "Fira Code", monospace; font-weight: 900; font-style: normal; }
        .fira-code-thin-italic { font-family: "Fira Code", monospace; font-weight: 100; font-style: italic; }
        .fira-code-light-italic { font-family: "Fira Code", monospace; font-weight: 300; font-style: italic; }
        .fira-code-regular-italic { font-family: "Fira Code", monospace; font-weight: 400; font-style: italic; }
        .fira-code-medium-italic { font-family: "Fira Code", monospace; font-weight: 500; font-style: italic; }
        .fira-code-bold-italic { font-family: "Fira Code", monospace; font-weight: 700; font-style: italic; }
        .fira-code-black-italic { font-family: "Fira Code", monospace; font-weight: 900; font-style: italic; }

        body { overflow: hidden; color: var(--button-text-color); }
        html body { margin: 0; padding: 0; background-color: var(--background-color); overflow-x: none; }
        #tabGroup { width: 100%; height: 100%; }
        nav { display: flex; justify-content: left; align-items: center; background-color: var(--navbar-background); width: 100vw; }
        .navLink { padding: 2vh 15px; color: var(--navbar-text-color); background-color: var(--navbar-background); transition: background-color 0.4s ease-in-out; font-size: medium; }
        .navLink:hover { background-color: var(--navbar-border-color); }
        .tab { display: none; height:95vh; width: 100vw; overflow: hidden; }
        .codeTextbox { background-color: var(--input-background-color); color: var(--input-text-color);border-radius: 0; height: 94vh; width: 100%; padding: 0; border: 0; resize: none; }
        .codeTextbox:focus { outline: 0; }
        a { text-decoration: none; color: var(--button-text-color); }
        a:disabled { pointer-events: none; }
        .dropdownContent { display: none; position: absolute; background-color: var(--button-color); min-width: 160px; overflow: auto; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; }
        .cmdDropdownBtn { text-align: right; display: inline; margin-left: 1rem; color: var(--button-active-color); right: 15px; position: absolute; margin: 0; }
        .dropdownBtn:hover > .cmdDropdownBtn { color: var(--button-color); }
        .dropdownBtn:hover { background-color: var(--button-hover-color); transition: color 0.4s ease-in-out; }
        .dropdownBtn { color: var(--navbar-text-color); padding: 12px 16px; text-decoration: none; display: block; transition: background-color 0.4s ease-in-out; padding-right: 100px; }
        .dropdown { opacity: 1; }
        .show { display: block; }
        .hide { display: none !important; }
        .newTabBtn { padding: 0.5rem 1.5rem; }
        .newTabMenu { height: 30vh; width: 20vw; background-color: #444444; padding: 5vh 2.5vw; }
        .newTabMenu ul { padding: 0; display: flex; justify-content: left; flex-direction: column; }
        .nameTxt { justify-self: right; display: inline;  background-color: var(--navbar-background); color: var(--navbar-text-color); border: none;  font-size: medium; text-align: right; }
        .nameTxt:focus { outline: 0; }
        .docTxt { justify-self: right; display: inline;  margin-left: -5px; }
        .perTxtNavStuff { right: 0; position: absolute; }

        #newTab { justify-content: center; align-items: center; }
        #nameTxt { display: none; }

        .modal { position: fixed; z-index: 2; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); padding-top: 60px; display: block; }
        .modal-content { background-color: var(--background-color); margin: 5% auto; padding: 20px; border: 1px solid var(--dark-gray); width: 300px; border-radius: 5px; }
        .modal-content > .close { color: var(--button-color); float: right; font-size: 28px; font-weight: bold; }
        .modal-content > .close:hover,
        .modal-content > .close:focus { color: var(--navbar-text-color); text-decoration: none; cursor: pointer; }
        .modal-content > input { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; color: var(--navbar-text-color); background-color: var(--background-color); border: 0; }
        .modal-content > input:focus { outline: 2px solid var(--navbar-border-color); border-radius: 5px; }
        .modal-content > button { padding: 8px 16px; margin-top: 10px; cursor: pointer;  }
        .modal-content > label { display: block; margin-top: 10px; }
        .modal-content > h4 { color: var(--navbar-text-color); }
    </style>
</head>
<body class="roboto-regular">
    <nav>
        <a class="navLink" href="#">Code Editor</a>
        <div class="dropdown">
            <a class="navLink navLinkTab" href="#" id="fileNavBtn" onclick="dropdown('file')">File</a>
            <div id="fileDropdown" class="dropdownContent">
                <a class="dropdownBtn" href="#" onclick="newDoc(); dropdown('file')">New <p class="cmdDropdownBtn">Ctrl + Shift + N</p></a>
                <a class="dropdownBtn" href="#" onclick="openFiles()">Open Files <p class="cmdDropdownBtn">Ctrl + O</p></a>
                <a class="dropdownBtn" href="#" onclick="saveFiles()">Save <p class="cmdDropdownBtn">Ctrl + S</p></a>
                <a class="dropdownBtn" href="#" onclick="saveFilesAs()">Save As <p class="cmdDropdownBtn">Ctrl + Shift + S</p></a>
                <a class="dropdownBtn" href="#" onclick="createBlank()">Open in New Tab <p class="cmdDropdownBtn">Ctrl + D</p></a>
                <a class="dropdownBtn" href="#" onclick="saveToFile()">Save (One File)</a>
                <a class="dropdownBtn" href="#" onclick="saveFileAs()">Save As (One File)</a>
            </div>
        </div>
        <div class="dropdown">
            <a class="navLink navLinkTab" href="#" id="editNavBtn" onclick="dropdown('edit')">Edit</a>
            <div id="editDropdown" class="dropdownContent">
                <a class="dropdownBtn" href="#" onclick="cutText()">Cut <p class="cmdDropdownBtn">Ctrl + X</p></a>
                <a class="dropdownBtn" href="#" onclick="copyText()">Copy <p class="cmdDropdownBtn">Ctrl + C</p></a>
                <a class="dropdownBtn" href="#" onclick="pasteText()">Paste <p class="cmdDropdownBtn">Ctrl + P</p></a>
                <a class="dropdownBtn" href="#" onclick="toggleModal()">Find and Replace <p class="cmdDropdownBtn">Ctrl + F</p></a>
            </div>
        </div>
        <a class="navLink navLinkTab" href="#" id="htmlNavBtn" onclick="tabName('HTML')">HTML</a>
        <a class="navLink navLinkTab" href="#" id="cssNavBtn" onclick="tabName('CSS')">CSS</a>
        <a class="navLink navLinkTab" href="#" id="jsNavBtn" onclick="tabName('JS')">JS</a>
        <a class="navLink" href="#" id="helpNavBtn" onclick="tabName('Help')">Help</a>

        <div class="perTxtNavStuff" id="HTMLTxt">
            <input class="nameTxt" type="text" placeholder="index" id="HTMLNameTxt">
            <p class="docTxt" id="HTMLDocExt">.html</p>
            <a class="navLink" onclick="openFile('html')" href="#">Open .html</a>
        </div>
        <div class="perTxtNavStuff" id="CSSTxt">
            <input class="nameTxt" type="text" placeholder="styles" id="CSSNameTxt">
            <p class="docTxt" id="CSSDocExt">.css</p>
            <a class="navLink" onclick="openFile('css')" href="#">Open .css</a>
        </div>
        <div class="perTxtNavStuff" id="JSTxt">
            <input class="nameTxt" type="text" placeholder="script" id="JSNameTxt">
            <p class="docTxt" id="JSDocExt">.js</p>
            <a class="navLink" onclick="openFile('js')" href="#">Open .js</a>
        </div>
        
    </nav>
    
    
    <div id="tabGroup">
        <div class="tab" style="display: none;" id="newTab">
            <div class="newTabMenu">
                <h2>Code Editor</h2>
                <ul>
                    <a href="#" class="newTabBtn" onclick="tabName('HTML')">New File</a>
                    <a href="#" class="newTabBtn" onclick="openFiles(); tabName('HTML')">Open Folder</a>
                </ul>
            </div>
        </div>
        <div class="tab" style="display: none;" id="HTMLTab">
            <textarea id="htmlTxt" class="codeTextbox fira-code-medium" spellcheck="false" wrap="soft">for /l %i in (1,1,254) do @ping -n 1 -w 1 1"Reply"</textarea>
        </div>
        <div class="tab" style="display: none;" id="CSSTab">
            <textarea id="cssTxt" class="codeTextbox fira-code-medium" spellcheck="false" wrap="soft">for /l %i in (1,1,254) do @ping -n 1 -w 1 192.168.1.%eply"</textarea>
        </div>
        <div class="tab" style="display: none;" id="JSTab">
            <textarea id="jsTxt" class="codeTextbox fira-code-medium" spellcheck="false" wrap="soft">for /l %ing -n 1 -w 1 192.168.1.%i | find "Reply"</textarea>
        </div>
        <div class="tab" style="display: none;" id="HelpTab">
            sdkfuhkjshdfj
        </div>
    </div>

    <div id="farModal" class="modal hide">
        <div class="modal-content">
          <span class="close" onclick="toggleModal()">&times;</span>
          <h4>Find and Replace</h4>
    
          <label for="find-input">Find:</label>
          <input type="text" id="find-input" placeholder="Text to find">
          
          <label for="replace-input">Replace with:</label>
          <input type="text" id="replace-input" placeholder="Replacement text">
    
          <label for="case-sensitivity">Case Sensitive:</label>
          <input type="checkbox" id="case-sensitivity">
    
          <button onclick="findAndReplace()">Replace</button>
        </div>
    </div>

    <script>
        const tabs = document.querySelectorAll('.tab');
        const textareas = document.querySelectorAll('.codeTextbox');
        const navLinkTabs = document.querySelectorAll('.navLinkTab');

        let currentTab = 'new';

        

        newDoc();

        function tabName(tabName) {
            currentTab = tabName;

            if (tabName == 'new') {
                hideTabs()
                document.getElementById("HTMLTxt").style.display = "none";
                document.getElementById("CSSTxt").style.display = "none";
                document.getElementById("JSTxt").style.display = "none";
                navLinkTabs.forEach(function(link) { link.style.display = "none"; });
                document.getElementById(tabName + "Tab").style.display = "flex";
            } else {
                hideTabs()
                document.getElementById("HTMLTxt").style.display = "none";
                document.getElementById("CSSTxt").style.display = "none";
                document.getElementById("JSTxt").style.display = "none";
                navLinkTabs.forEach(function(link) { link.style.display = "inline"; });
                document.getElementById(tabName + "Txt").style.display = "inline";
                document.getElementById(tabName + "Tab").style.display = "block";
                chgTitle(tabName)
            };
        }

        function newDoc() {
            tabName('new')
            document.getElementById("htmlTxt").value = atob("PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICA8bWV0YSBodHRwLWVxdWl2PSJYLVVBLUNvbXBhdGlibGUiIGNvbnRlbnQ9ImllPWVkZ2UiPgogICAgPHRpdGxlPkhUTUwgVGVtcGxhdGU8L3RpdGxlPgoKICAgIDwhLS0gTGluayB0byBleHRlcm5hbCBDU1MgLS0+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9InN0eWxlcy5jc3MiPgoKPC9oZWFkPgo8Ym9keT4KCiAgICA8IS0tIENvbnRlbnQgZ29lcyBoZXJlIC0tPgoKICAgIDwhLS0gTGluayB0byBleHRlcm5hbCBKYXZhU2NyaXB0IC0tPgogICAgPHNjcmlwdCBzcmM9InNjcmlwdC5qcyI+PC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPg==")
            document.getElementById("cssTxt").value = atob("aHRtbCBib2R5IHsKICAgIG1hcmdpbjogMDsKfQ==")
            document.getElementById("jsTxt").value = atob("d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCBhc3luYyAoZXZlbnQpID0+IHsKICAgIGlmIChldmVudC5rZXkgPT09ICJzIikgewogICAgCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CglhbGVydCgiWW91IHByZXNzZWQgLT4gcyEhISEhIik7Cn19KTs=")
            document.getElementById("HTMLNameTxt").value = "index";
            document.getElementById("CSSNameTxt").value = "styles";
            document.getElementById("JSNameTxt").value = "script";
        }

        function hideTabs() {
            tabs.forEach(function(tab) {
                tab.style.display = 'none';
            });
        }

        function chgTitle(titleName) {
            if (titleName == undefined) {
                document.title = "Code Editor";
            } else {
                document.title = titleName + " | Code Editor";
            };
        };

        function createBlank() {
            var code = compileDoc();
            var win = window.open();
            win.document.body.style.margin = '0';
            win.document.body.style.height = '100vh';
            var iframe = win.document.createElement('iframe');
            iframe.style.border = 'none';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.margin = '0';
            iframe.srcdoc = code;
            win.document.body.appendChild(iframe);
        }

        function saveOneFile() {
            const docName = document.getElementById('HTMLNameTxt').value;
            const content = compileDoc()
            const blob = new Blob([content]);
            // const blob = new Blob([content], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = docName + '.html';
            a.click();
        };

        function compileDoc() {
            var compDoc = document.getElementById("htmlTxt").value;
            var cssTxt = document.getElementById("cssTxt");
            var jsTxt = document.getElementById("jsTxt");

            compDoc = compDoc.replace('<link rel="stylesheet" href="' + document.getElementById("CSSNameTxt").value + '.css">', "<style>" + cssTxt.value + "<\/style>");
            compDoc = compDoc.replace(atob("PHNjcmlwdCBzcmM9Ig==") + document.getElementById("JSNameTxt").value + atob("LmpzIj48L3NjcmlwdD4="), "<script>" + jsTxt.value + "<\/script>");
            compDoc = compDoc.replace('&lt;link rel="stylesheet" href="' + document.getElementById("CSSNameTxt").value + '.css"&gt;', "<style>" + cssTxt.value + "<\/style>");
            compDoc = compDoc.replace('&lt;script src="' + document.getElementById("JSNameTxt").value + '.js"&gt;&lt;/script&gt;', "<script>" + jsTxt.value + "<\/script>");
            
            return compDoc;
        }

        textareas.forEach(function(textarea) {
            textarea.addEventListener('keydown', function(e) {
                if (e.key == 'Tab') {
                e.preventDefault();
                var start = this.selectionStart;
                var end = this.selectionEnd;

                // set textarea value to: text before caret + tab + text after caret
                this.value = this.value.substring(0, start) +
                    "\t" + this.value.substring(end);

                // put caret at right position again
                this.selectionStart = this.selectionEnd = start + 1;
                }
            });
        });

        function dropdown(from) {
            document.getElementById(from + "Dropdown").classList.toggle("show");

            var d = document.getElementById(from + "Dropdown");
            let x_pos = event.ClientX
            let y_pos = event.ClientY

            d.style.position = "absolute";
            d.style.left = x_pos+'px';
            d.style.top = y_pos+'px';
        }

        // Toggle the modal visibility by toggling the "hide" class
        function toggleModal() {
            const modal = document.getElementById('farModal');
            modal.classList.toggle('hide');  // Toggle the hide class
        }

        // Find and Replace function with Case Sensitivity Toggle
        function findAndReplace() {
            const textarea = document.getElementById('htmlTxt');
            if (tabName == 'HTML') { textarea = document.getElementById('htmlTxt'); }
            if (tabName == 'CSS') { textarea = document.getElementById('cssTxt'); }
            if (tabName == 'JS') { textarea = document.getElementById('jsTxt'); }

            const findText = document.getElementById('find-input').value;
            const replaceText = document.getElementById('replace-input').value;
            const isCaseSensitive = document.getElementById('case-sensitivity').checked;

            if (findText !== '') {
                // Set up regular expression with or without case sensitivity
                const flags = isCaseSensitive ? 'g' : 'gi';  // 'g' for global, 'i' for case-insensitive
                const regex = new RegExp(findText, flags);
                
                // Replace all occurrences of findText with replaceText
                textarea.value = textarea.value.replace(regex, replaceText);
                toggleModal(); // Close the modal after replacing
            } else {
                alert('Please enter text to find!');
            }
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('farModal');
            if (event.target === modal) {
                toggleModal();
            }

            // const dropdowns = ['file', 'edit']
            // for (let i = 0; i < dropdowns.length; i++) {
            //     closeDropdown(dropdowns[i])
            // }
        }

        // function closeDropdown(type) {
        //     if (!event.target.matches('#' + type + 'NavBtn')) {
        //         var dropdowns = document.getElementsByClassName("dropdownContent");
        //         var i;
        //         for (i = 0; i < dropdowns.length; i++) {
        //             var openDropdown = dropdowns[i];
        //             if (openDropdown.classList.contains('show')) {
        //                 openDropdown.classList.remove('show');
        //             }
        //         }
        //     }
        // }

        

        // Function to auto-indent code in the textarea
        function autoIndentTextarea(textarea) {
            // Split the textarea value by new lines
            let lines = textarea.value.split("\n");
            
            for (let i = 1; i < lines.length; i++) {
            // Check if the previous line ends with a function declaration or block opening (e.g. function testFunc() {)
            let prevLine = lines[i - 1].trim();
            
            // Basic checks for function-like declarations or block-opening lines
            if (prevLine.endsWith("{") || prevLine.includes("function")) {
                // Indent the current line by 4 spaces (or more if needed)
                lines[i] = "    " + lines[i].trimStart();
            }
            // Optionally, you can also un-indent if a closing curly brace is found
            else if (prevLine.endsWith("}")) {
                // Remove indentation for lines after a closing brace
                lines[i] = lines[i].trimStart();
            }
            }

            // Join the lines back together
            textarea.value = lines.join("\n");
        }

        // Loop through all textarea elements and add event listener for keydown
        textareas.forEach(function(textarea) {
            textarea.addEventListener('keydown', function(event) {
                // Call the auto-indent function whenever the user types
                autoIndentTextarea(textarea);
                
                // Call the bracket completion function
                autoCompleteBrackets(textarea, event);
            });
        });

        // Function to automatically complete brackets and similar pairs
        function autoCompleteBrackets(textarea, event) {
            const char = event.key; // Get the character that was pressed
            const cursorPos = textarea.selectionStart; // The current position of the cursor
            const value = textarea.value; // The current value of the textarea
            const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd); // The highlighted text (if any)

            // Define matching pairs of brackets and quotes
            const pairs = {
                '(': ')',
                '{': '}',
                '[': ']',
                '"': '"',
                "'": "'"
            };

            // If the user presses an opening bracket, automatically insert the closing bracket
            if (pairs[char]) {
                event.preventDefault(); // Prevent the default input of the character

                // If there's selected text, wrap it with brackets
                if (selectedText) {
                    // Insert the opening and closing brackets around the selected text
                    textarea.value = value.substring(0, cursorPos) + char + selectedText + pairs[char] + value.substring(textarea.selectionEnd);
                    // Move the cursor to the position after the inserted closing bracket
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + char.length + selectedText.length + pairs[char].length;
                } else {
                    // Otherwise, just insert the opening bracket and the closing bracket after it
                    textarea.value = value.substring(0, cursorPos) + char + pairs[char] + value.substring(cursorPos);
                    // Move the cursor between the two inserted brackets
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + char.length;
                }
            }

            // If the user presses a closing bracket, handle it
            const closingBrackets = Object.values(pairs);
            if (closingBrackets.includes(char)) {
                // Check if the character typed is a closing bracket
                const matchingOpeningChar = getMatchingOpeningBracket(value, cursorPos, char);
                if (matchingOpeningChar) {
                    // If the character is part of a valid pair, let it be typed as normal
                    return;
                }
            }
        }

        // Function to get the matching opening bracket for a given closing bracket
        function getMatchingOpeningBracket(value, cursorPos, closingChar) {
            const openingChars = ['(', '{', '[', '"', "'"];
            const closingChars = [')', '}', ']', '"', "'"];
            
            // Find the index of the closing bracket
            const closingIndex = closingChars.indexOf(closingChar);
            const matchingOpeningChar = openingChars[closingIndex];

            let stack = [];
            // Loop through the text from the cursor position backwards to find a matching opening bracket
            for (let i = cursorPos - 1; i >= 0; i--) {
                const char = value[i];
                
                if (char === matchingOpeningChar) {
                    if (stack.length === 0) {
                        return matchingOpeningChar;  // Found the matching opening bracket
                    }
                    stack.pop();  // Unmatched opening bracket found, so pop from the stack
                }
                
                if (closingChars.includes(char)) {
                    stack.push(char);  // Push closing brackets onto the stack
                }
            }
            return null;  // No matching opening bracket found
        }

////////////////////////////////////// Saving and Loading //////////////////////////////////////
        let fileHandle; // Store the file handle for saving
        let fileHandleHTML;
        let fileHandleCSS;
        let fileHandleJS;

        async function openFile(type) {
            // Show file picker to open a file
            if (type === 'html') {
                [fileHandle] = await window.showOpenFilePicker({
                    types: [
                        {
                            description: "HTML Files",
                            accept: { "text/html": [".html"] },
                        },
                    ],
                });
            }
            if (type === 'css') {
                [fileHandle] = await window.showOpenFilePicker({
                    types: [
                        {
                            description: "CSS Files",
                            accept: { "text/css": [".css"] },
                        },
                    ],
                });
                await loadCSS(fileHandle);
                return;
            }
            if (type === 'js') {
                [fileHandle] = await window.showOpenFilePicker({
                    types: [
                        {
                            description: "JavaScript Files",
                            accept: { "text/js": [".js"] },
                        },
                    ],
                });
                await loadJS(fileHandle);
                return;
            }

            // Read and load file content
            const file = await fileHandle.getFile();
            const content = await file.text();

            // Parse the HTML content using DOMParser
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');

            // Handle <style> tags: Replace them with <link rel="stylesheet" href="styles.css">
            const styleTags = doc.querySelectorAll('style');
            styleTags.forEach(style => {
                style.replaceWith('<link rel="stylesheet" href="styles.css">');
            });

            // Handle <script> tags: Replace them with <script src="script.js"><(dont put / here)script>
            const scriptTags = doc.querySelectorAll('script');
            scriptTags.forEach(script => {
                let scriptContent = script.textContent.replace(/<\/script>/g, '<\\/script>');
                script.replaceWith(atob("PHNjcmlwdCBzcmM9InNjcmlwdC5qcyI+PC9zY3JpcHQ+"));
            });

            // Get the final HTML string (modified)
            const modifiedHTML = doc.documentElement.outerHTML;

            // Set the modified HTML as the value of the textarea
            // Encode the HTML content before inserting it to avoid escaping
            document.getElementById("htmlTxt").value = modifiedHTML;

            // Optionally, show the extracted styles and scripts in separate text areas (or whatever else you need)
            document.getElementById("cssTxt").value = Array.from(styleTags).map(style => style.innerHTML).join('\n');
            document.getElementById("jsTxt").value = Array.from(scriptTags).map(script => script.textContent).join('\n');
        }

        async function loadCSS(fileHandle) {
            const file = await fileHandle.getFile();
            const content = await file.text();

            document.getElementById("cssTxt").value = content;
        }

        async function loadJS(fileHandle) {
            const file = await fileHandle.getFile();
            const content = await file.text();

            document.getElementById("jsTxt").value = content;
        }

        // Function to handle encoding HTML (for the textarea)
        function encodeHTML(html) {
            const element = document.createElement('div');
            if (html) {
                element.innerText = html;
                element.textContent = html;
            }
            return element.innerHTML;
        }

        async function saveFileAs() {
            // Show save file picker to create or overwrite a file
            [fileHandle] = await window.showSaveFilePicker({
                suggestedName: "index.html",
                types: [
                    {
                        description: "HTML Files",
                        accept: { "text/html": [".html"] },
                    },
                ],
            });

            // Write content to the newly selected file
            await saveToFile();
        }

        async function saveToFile() {
            if (!fileHandle) {
                // If no file is open, prompt to save as
                await saveFileAs();
                return;
            }

            const writableStream = await fileHandle.createWritable();
            await writableStream.write(compileDoc());
            await writableStream.close();
        }

        async function saveFiles() {
            if (!fileHandle) {
                await saveFilesAs();
                return;
            }

            const writableStream = await fileHandle.createWritable();
            await writableStream.write(compileDoc());
            await writableStream.close
        }

        // Copy text to clipboard using Clipboard API
        async function copyText() {
            const textarea = document.getElementById('htmlTxt');
            if (tabName == 'HTML') { textarea = document.getElementById('htmlTxt'); }
            if (tabName == 'CSS') { textarea = document.getElementById('cssTxt'); }
            if (tabName == 'JS') { textarea = document.getElementById('jsTxt'); }

            try {
                await navigator.clipboard.writeText(textarea.value);
                alert('Text copied to clipboard!');
            } catch (err) {
                console.error('Error copying text: ', err);
            }
        }

        // Paste text from clipboard into the textarea using Clipboard API
        async function pasteText() {
            const textarea = document.getElementById('htmlTxt');
            if (tabName == 'HTML') { textarea = document.getElementById('htmlTxt'); }
            if (tabName == 'CSS') { textarea = document.getElementById('cssTxt'); }
            if (tabName == 'JS') { textarea = document.getElementById('jsTxt'); }

            try {
                const text = await navigator.clipboard.readText();
                textarea.value = text; // Paste the clipboard text into the textarea
            } catch (err) {
                console.error('Error pasting text: ', err);
            }
        }

        // For "cut", we can use a combination of copy and delete
        async function cutText() {
            const textarea = document.getElementById('htmlTxt');
            if (tabName == 'HTML') { textarea = document.getElementById('htmlTxt'); }
            if (tabName == 'CSS') { textarea = document.getElementById('cssTxt'); }
            if (tabName == 'JS') { textarea = document.getElementById('jsTxt'); }

            try {
                await navigator.clipboard.writeText(textarea.value); // Copy the content to clipboard
                textarea.value = ''; // Clear the textarea (cutting)
                alert('Text cut and copied to clipboard!');
            } catch (err) {
                console.error('Error cutting text: ', err);
            }
        }

        // Function to read a file and output its content to the corresponding textarea
        function readFile(file, textareaId, fileNameID) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(textareaId).value = e.target.result; // Set the content of the textarea
                
                // Remove .css, .html, or .js extension from the filename
                let fileName = file.name;
                fileName = fileName.replace(/\.(css|html|js)$/i, ''); // Removes .css, .html, or .js extensions
                
                document.getElementById(fileNameID).value = fileName; // Set the file name without the extension
            };
            reader.readAsText(file); // Read the file as text
        }

        async function openFiles() {
            try {
                // Open folder picker
                const directoryHandle = await window.showDirectoryPicker();

                let cssFile, jsFile, htmlFile;
                let cssName, jsName, htmlName;

                // Iterate over all files in the selected directory
                for await (const entry of directoryHandle.values()) {
                    const file = await entry.getFile();

                    // Check file extension and assign to the correct variable
                    if (file.name.endsWith('.css')) {
                        cssFile = file;
                    } else if (file.name.endsWith('.js')) {
                        jsFile = file;
                    } else if (file.name.endsWith('.html')) {
                        htmlFile = file;
                    }
                }

                // Read the contents of the files if they exist
                if (cssFile) readFile(cssFile, 'cssTxt', 'CSSNameTxt');
                if (jsFile) readFile(jsFile, 'jsTxt', 'JSNameTxt');
                if (htmlFile) readFile(htmlFile, 'htmlTxt', 'HTMLNameTxt');
            } catch (error) {
                console.error("Directory picker error:", error);
            }
        }

        // Event listener for keyboard shortcuts
        window.addEventListener("keydown", async (event) => {
            // Ctrl + S: Save To File
            if (event.ctrlKey && event.key === "s" && !event.shiftKey) {
                event.preventDefault();
                await saveToFile();
            }

            // Ctrl + Shift + S: Save As
            if (event.ctrlKey && event.shiftKey && event.key === "S") {
                event.preventDefault();
                await saveFileAs();
            }

            // Ctrl + Shift + F: Find And Replace
            if (event.ctrlKey && event.shiftKey && event.key === "F") {
                event.preventDefault();
                await toggleModal();
            }

            // Ctrl + D: Open In New Tab
            if (event.ctrlKey && event.key === "d") {
                event.preventDefault();
                await createBlank();
            }

            // Ctrl + O: Open Folder
            if (event.ctrlKey && event.key === "o") {
                event.preventDefault();
                await openFiles();
            }

            // Ctrl + Shift + N: New Project
            if (event.ctrlKey && event.shiftKey && event.key === "N") {
                event.preventDefault();
                await openFiles();
            }
        });
    </script>
</body>
</html>